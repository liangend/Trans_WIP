---
title: ''
output:
  workflowr::wflow_html:
              toc: true
              toc_depth: 4
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE)
```

```{css style settings, echo = FALSE}
blockquote {
    padding: 10px 20px;
    margin: 0 0 20px;
    font-size: 14px;
    border-left: 5px solid #eee;
}
```
## 5/1/2023

### 1. Distribution of trans signals
32/199 modules were found to have at least one significant trans signal in GTEx blood. In contrast, 102/166 modules were found to have trans-eQTLs in DGN. Most signals were observed in module 135 with 105 SNPs in GTEx (module 51 with 695 SNPs in DGN).
```{r echo=F, fig.align='center', fig.cap="p values of the SNP-module"}
knitr::include_graphics(c("assets/mod_dist.png"), error = FALSE)
```

Most signals were found on chromosome 3. In GTEx blood, there are significant 108 SNPs from chr3 (1237 SNPs from chr3 in DGN). Out of these 108 SNPs, 105 SNPs are relative to module 135 (652/1237 SNPs from chr3 are relative to module 51 in DGN).
```{r echo=F, fig.align='center', fig.cap="p values of the SNP-module"}
knitr::include_graphics(c("assets/chr_dist.png"), error = FALSE)
```
Genes in module 135 of GTEx: AURKC, HKR1, ZNF134, ZNF135, ZNF211, ZNF256, ZNF304, ZNF329, ZNF347, ZNF418, ZNF543, ZNF544, ZNF548, ZNF549, ZNF550, ZNF551, ZNF585B, ZNF606, ZNF671, ZNF772, ZNF776, ZSCAN18

Genes in module 51 of DGN (61 genes): AURKC, HKR1, LINC00665, PHKB, TRAPPC2P1, ZFP28, ZFP82, ZIK1, ZNF107, ZNF134, ZNF135, ZNF154, ZNF160, ZNF211, ZNF256, ZNF274, ZNF285, ZNF304, ZNF320, ZNF329, ZSCAN18, etc.

20/22 genes in module 135 of GTEx overlaps with module 51 of DGN. Functions of module 135 involves RNA polymerase II transcription regulation and binding, DNA-binding transcription factor activity.

### 2. Simulation of the effect of # genes and samples on the detection of significant modules
I simulated a module with 100/200 genes, with one gene causally regulated by a SNP. Heritability of the gene was set to be 0.05. The genotype of the SNP was randomly generated for 10/100/500/700/1000 individuals. Expression of other genes were generated from N(0, 1). In total 100 simulations were conducted for each scenario.
```{r echo=F, fig.align='center', fig.cap="p values of the SNP-module"}
knitr::include_graphics(c("assets/sim_ngene_nsample.png"), error = FALSE)
```
The more genes in one module, the more samples required to detect the signal.

## 4/12/2023

### 1. New read count results based on adjusted GENCODE gtf (for GTEx V8)
After QC and removing genes on chrX, chrM and chrY, 12929 genes for 670 individuals were kept. Among these genes, 12039 are protein coding genes and lincRNA.

#### Compare my TPM with GTEx TPM (including genes on chrX, chrM and chrY)
14047 genes with cor > 0.85; 32 genes with cor <= 0.85
```{r echo=F, fig.align='center', fig.cap="Cor between GTEx TPM and my TPM"}
knitr::include_graphics(c("assets/tpm_cor.png"), error = FALSE)
```

```{r echo=F, fig.align='center', fig.cap="TPM of selected genes"}
knitr::include_graphics(c("assets/gene_tpm.png"), error = FALSE)
```

13196 genes with mean TPM < 100 for both groups.
```{r echo=F, fig.align='center', fig.cap="Mean TPM across 670 individuals"}
knitr::include_graphics(c("assets/mean_tpm.png"), error = FALSE)
```

### 2. Compare PC with PEER
For the normalized TPM, the first 60 PCs and PEER factors are highly correlated.
```{r echo=F, fig.align='center', fig.cap="Correlation between PC and PEER factor"}
knitr::include_graphics(c("assets/pc_peer_cor.png"), error = FALSE)
```
Zhou et al. (2022) suggested that PCA performs close to or better than PEER factors for QTL mapping under different scenarios, but with much shorter time and better interpretability.

### 3. Coexpression analysis
I used 5 genotype PCs, 3 factors (sex, pcr, platform), and different numbers (10 and 60) of expression PCs or PEER factors as the covariates to obtain the residual expression, which is further used as the input of WGCNA.

I used the elbow method (Zhou et al., 2022) the optimized the number of PCs to be included. 
```{r echo=F, fig.align='center', fig.cap="Optimize the number of PCs using the elbow method"}
knitr::include_graphics(c("assets/pc_elbow.png"), error = FALSE)
```
Another optimization method, BE algorithm, tends to include more PCs than the elbow method, but both are fewer the number of PEER factors included in the GTEx paper.

Number of modules, unassigned genes, and genes in top 3 modules when including different number of PCs or PEER factors.
```{r echo=F, fig.align='center', fig.cap=""}
knitr::include_graphics(c("assets/coexp_comp.png"), error = FALSE)
```

```{r echo=F, fig.align='center', fig.cap="Cluster dendrogram of genes when including 19 PCs"}
knitr::include_graphics(c("assets/wgcna_dendro_19pc.png"), error = FALSE)
```

For trans-PCO analysis, I conducted co-expression analysis based on 5 genotype PCs, 3 factors (sex, pcr, platform), and 10 expression PCs, which resulted in 199 modules, 235 unassigned genes, and top 3 modules containing 858, 481, and 475 genes.

#### Functional profiling of gene modules
To check the sanity of gene module classification, I investigated the enrichment of GO terms (FDR < 0.05) for several gene modules using g:Profiler.
```{r echo=F, fig.align='center', fig.cap="Shared and unique GO terms for module 5, 6 and 7"}
knitr::include_graphics(c("assets/mod_go.png"), error = FALSE)
```
Top 3 significant BP terms:

module 5 (313 genes): leukocyte activation, cell activation, lymphocyte activation;

module 6 (312 genes): defense response to symbiont, defense response to virus, response to virus;

module 7 (307 genes): wound healing, platelet activation, blood coagulation.

Another example:
```{r echo=F, fig.align='center', fig.cap="Shared and unique GO terms for module 106, 107 and 108"}
knitr::include_graphics(c("assets/mod_go2.png"), error = FALSE)
```
Top 3 significant BP terms:

module 106 (31 genes): extracellular structure organization, extracellular matrix organization, external encapsulating structure organization;

module 107 (31 genes): monosaccharide metabolic process, hexose metabolic process, glucose metabolic process;

module 108 (31 genes): None

### 4. cis-eQTL analysis
Included 5 genotype PCs, 3 factors (sex, pcr, platform), 10 expression PCs as covariates. 

Genotype data: 46,569,704 variants after QC. 10,726,114 SNPs (MAF >= 0.01) were included in the cis-eQTL analysis.

12360 eGenes (qval < 0.05) in GTEx data; 6067 eGenes in my analysis. Among 12360 eGenes reported by GTEx, there are 3858 genes not included in our analysis.
```{r echo=F, fig.align='center', fig.cap="Comparison of number of eGenes"}
knitr::include_graphics(c("assets/egene_venn.png"), error = FALSE)
```

1906 same top variants associated with the same eGene. Slope cor = 0.99
```{r echo=F, fig.align='center', fig.cap="Comparison of the slopes of shared variants"}
knitr::include_graphics(c("assets/cis_eqtl_slope_comp.png"), error = FALSE)
```

When using the same covarites (60 PEER factors) as GTEx, the number of eGenes increases to 8320.

### 5. trans-eQTL analysis
Included 5 genotype PCs, 3 factors (sex, pcr, platform), 60 expression PCs as covariates. 

Genotype data: 6,568,202 SNPs (MAF >= 0.05; 6.2 million SNPs in DGN) were included in the trans-eQTL analysis.

#### trans-eQTL mapping based on 166 gene modules from Wang et al. (2022)
In trans-eQTL mapping for DGN, there are 3899 significant trans-eQTL SNPâ€“module pairs (Wang et al., 2022). For the 12132 genes (166 gene modules) included in Wang et al. (2022), there are 10547 genes included in my analysis. Among 3330 shared SNP-gene module pairs, 470 (14.0%) were replicated in my analysis (p < 0.05/3330).
```{r echo=F, fig.align='center', fig.cap="Trans-eQTL replication for DGN"}
knitr::include_graphics(c("assets/trans_sig_rep.png"), error = FALSE)
```

#### trans-eQTL mapping based on 199 gene modules
In total 159 significant signals were found in GTEx data (p < 5e-8). I then investigated the regulatory activity of these signals and those from Wang et al. (2022) based on chromatin states of neutrophils from peripheral blood (Roadmap project).
```{r echo=F, fig.align='center', fig.cap="Functional enrichment of significant trans signals"}
knitr::include_graphics(c("assets/trans_func_enrich.png"), error = FALSE)
```

GTEx V8 reported 13 trans-eQTLs in whole blood (Wang et al., 2022), and 4 (30.8%) were replicated in my analysis (p < 0.05/13).
```{r echo=F, fig.align='center', fig.cap="Trans-eQTL replication for GTEx"}
knitr::include_graphics(c("assets/trans_gtex_rep.png"), error = FALSE)
```

## 3/8/2023

### 1. Comparing the p values of PCO and ACAT on Lili's demo
Number of variant-module associations = 136,904. Correlation of two p values = 0.77

Correlation of two p values (both < 0.05) = 0.73
```{r echo=F, fig.align='center', fig.cap="Comparing the p values of PCO and ACAT"}
knitr::include_graphics(c("assets/pco_acat_comp.png"), error = FALSE)
```

## 2/21/2023

### 1. Summary

Use GTEx data to generate a whole-genome Trans-eQTL map based on TransPCO.

### 2. Use whole blood data as the initial test

- 670 samples of RNAseq

- 26584 genes

- Filter by mapping quality = 255 (uniquely mapping reads; [STAR mapping manual](https://physiology.med.cornell.edu/faculty/skrabanek/lab/angsd/lecture_notes/STARmanual.pdf))

- More strict way to count read
![](assets/count_modes.png){width="90%"}
- Filter by CPM (counts per million)

For each gene, count the number of samples with CPM > 0.5. 11771 genes kept if filter by number of samples with CPM > 0.5 greater than 10% of total samples.
```{r echo=F, fig.align='center', fig.cap="Figure 1: Number of genes kept with different CPM filtering criteria."}
knitr::include_graphics(c("assets/Fig1.png"), error = FALSE)
```

- Normalize RPKM (Reads per kilo base of transcript per million)
```{r out.width="80%", fig.cap="Figure 2: Density of normalized RPKM of randomly selected 10 genes.", fig.align='center', echo=F}
knitr::include_graphics(c("assets/Fig2.png"), error = FALSE)
```

The problematic left tails are caused by too many ties (0's) for genes that are only found in few samples.
```{r out.width="80%", fig.cap="Figure 3: Density of normalized RPKM and original counts of 3 example genes.",fig.align='center', echo=F}
knitr::include_graphics(c("assets/Fig3.png"), error = FALSE)
```


When filtering by number of samples with CPM > 0.5 greater than 20% of total samples (10003 genes kept).
```{r out.width="80%", fig.cap="Figure 4: Density of normalized RPKM of randomly selected 10 genes using 20% of samples as cutoff.",fig.align='center', echo=F}
knitr::include_graphics(c("assets/Fig4.png"), error = FALSE)
```



